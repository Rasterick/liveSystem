<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Horizon's Threat Analysis</title>

    <style>
        body {
            background-color: #1a1a1a; /* Dark background */
            color: #f0f0f0; /* Light text */
            font-family: sans-serif;
            padding: 20px;
        }
        
        /* --- Input and Layout Grid --- */
        #analysis-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 900px;
            margin: 0 auto; /* Center the form */
        }
        
        #input-grid {
            display: flex;
            gap: 20px;
        }

        #left-inputs {
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex-grow: 1; /* Allow left side to take available space */
        }
        
        #probe-scan-wrapper {
            flex-grow: 2; /* Allow textarea to take more space */
        }
        
        #probe-scan-paste {
            width: 100%;
            height: 100%; /* Fill the container height */
            min-height: 150px;
            resize: none;
            border: 1px solid #444;
            background-color: #2c2c2c;
            color: #f0f0f0;
            padding: 10px;
            box-sizing: border-box;
        }

        /* Input styling */
        #left-inputs input, #left-inputs label {
            display: block;
            width: 100%;
            padding: 8px;
            border: 1px solid #444;
            background-color: #2c2c2c;
            color: #f0f0f0;
            box-sizing: border-box;
        }
        
        /* --- Summary Boxes --- */
        #summary-section {
            display: flex;
            gap: 20px;
            margin: 25px auto; /* Center below form */
            max-width: 900px;
        }

        .summary-box {
            background-color: #2c2c2c;
            border: 1px solid #444;
            padding: 15px;
            border-radius: 5px;
            min-width: 250px;
        }

        .summary-box h4 {
            color: #aaa;
            margin-top: 0;
            font-size: 0.9em;
        }

        .total-isk {
            color: #4CAF50; /* Green highlight for value */
            font-size: 1.8em;
            font-weight: bold;
        }

        /* --- Table Styling --- */
        #anomalies-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        #anomalies-table th, 
        #anomalies-table td {
            padding: 10px 15px;
            text-align: left;
            border-bottom: 1px solid #3a3a3a;
        }

        #anomalies-table th {
            background-color: #333;
            color: #fff;
            font-weight: normal;
            text-transform: uppercase;
            font-size: 0.85em;
        }

        #anomalies-table tbody tr:nth-child(even) {
            background-color: #242424;
        }
        
        .value-zero { color: #f44336; font-weight: bold; }
        .value-calculated { color: #4CAF50; }
    
	/* --- Input and Layout Grid --- */
#input-grid {
    display: flex;
    gap: 20px;
    align-items: stretch; /* Ensures columns stretch to max height */
    padding-bottom: 20px; /* Space above the separator line */
}

/* Grouping labels and inputs */
.input-group {
    display: flex;
    flex-direction: column; /* Stack label over input */
    gap: 5px; /* Small space between label and input */
    margin-bottom: 15px; /* Space between input groups */
}

/* Ensure labels are distinctly above the fields */
#left-inputs label,
#probe-scan-wrapper label {
    font-size: 0.9em;
    color: #f0f0f0; /* Use light color for distinct labels */
    padding: 0;
    margin-bottom: 3px; /* Space under the label */
    border: none; /* Ensure labels have no background/border from previous styling */
    background: none;
}

/* Make inputs uniform */
#left-inputs input {
    padding: 10px;
    border: 1px solid #444;
    background-color: #2c2c2c;
}

/* Ensure the textarea wrapper aligns everything */
#probe-scan-wrapper {
    flex-grow: 2; /* Takes up most space */
    display: flex;
    flex-direction: column;
}

#probe-scan-paste {
    flex-grow: 1; /* Makes the textarea fill all available height */
    min-height: 150px;
    /* Maintain existing styling */
    border: 1px solid #444;
    background-color: #2c2c2c;
    color: #f0f0f0;
    padding: 10px;
    box-sizing: border-box;
}

/* Ensure button is also styled */
#analyze-button {
    padding: 10px 20px;
    background-color: #007bff; /* Standard blue button */
    color: white;
    border: none;
    cursor: pointer;
    border-radius: 5px;
    margin-top: 10px;
    max-width: 150px;
}    
    </style>
</head>
<body>
    <div class="formcarry-container">
        <h1>Horizon's System Value</h1>
        <form id="analysis-form" class="formcarry-form">
    <div id="input-grid">
        
        <div id="left-inputs">
            
            <div class="input-group">
                <label for="system-input">System</label>
                <input type="text" id="system-input" name="system_name" value="J121116" required />
            </div>

            <div class="input-group">
                <label for="structures-input">Structures</label>
                <input type="text" id="structures-input" name="structures_count" value="0" required />
            </div>
            
            <button type="submit" id="analyze-button">Analyze Scan</button>
        </div>
        
        <div id="probe-scan-wrapper">
            <label for="probe-scan-paste">Probe Scan Paste</label>
            <textarea id="probe-scan-paste" name="scan_paste" placeholder="Copy and Paste Scan Results here..." rows="10"></textarea>
        </div>
    </div>
</form>
    </div>

    <hr>
    
    <section id="results-area">
        <h2>Scan Results Summary</h2>

        <div id="summary-section">
            <div class="summary-box">
                <h4>Estimated System Worth</h4> <p id="grand-total-value" class="total-isk">Awaiting Data...</p>
            </div>
            <div class="summary-box">
                <h4>Total Sites Found</h4>
                <p id="total-sites-count">0</p>
            </div>
        </div>

        <div id="results-container">
            <table id="anomalies-table">
                <thead>
                    <tr>
                        <th>Site Name</th>
                        <th>Group</th>
                        <th>Count</th>
                        <th>Est. Base Value</th>
                        <th>Total Worth (ISK)</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>

        <p id="status-message" class="hidden"></p>
    </section>

    <script>
        const WEBHOOK_URL = 'https://n8n.grim-horizon.org/webhook/testForm_001';

        document.getElementById('analysis-form').addEventListener('submit', function(event) {
            event.preventDefault();
            handleAnalysis();
        });

        async function handleAnalysis() {
            const form = document.getElementById('analysis-form');
            const resultContainer = document.querySelector('#anomalies-table tbody');
            const grandTotalElement = document.getElementById('grand-total-value');
            const totalSitesElement = document.getElementById('total-sites-count');

            // Clear previous results and set status
            resultContainer.innerHTML = '<tr><td colspan="5">Processing data...</td></tr>';
            grandTotalElement.textContent = 'Processing...';
            totalSitesElement.textContent = '...';

            const payload = {
                system_name: document.getElementById('system-input').value,
                structures_count: document.getElementById('structures-input').value,
                scan_data: document.getElementById('probe-scan-paste').value
            };

            try {
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP Error! Status: ${response.status}`);
                }

                
		const responseText = await response.text();
		const dataArray = JSON.parse(responseText.trim());

		const data = dataArray[0];



                // --- Display Logic ---
                if (data && data.grandTotal !== undefined && data.breakdown) {
                    const totalSites = data.breakdown.reduce((sum, item) => sum + item.count, 0);
                    
                    const formattedTotal = formatIsk(data.grandTotal);
                    grandTotalElement.textContent = formattedTotal;
                    totalSitesElement.textContent = totalSites;

                    buildResultsTable(data.breakdown, resultContainer);
                } else {
                    grandTotalElement.textContent = 'Error: Invalid data format.';
                    resultContainer.innerHTML = '<tr><td colspan="5">Could not parse data from server.</td></tr>';
                }

            } catch (error) {
                console.error('Analysis failed:', error);
                grandTotalElement.textContent = 'Analysis Failed.';
                resultContainer.innerHTML = `<tr><td colspan="5">Connection/Server Error. (${error.message})</td></tr>`;
            }
        }
        
        function formatIsk(value) {
            if (typeof value !== 'number') return 'N/A';
            return value.toLocaleString(undefined, { maximumFractionDigits: 2 }) + ' ISK';
        }

        function buildResultsTable(breakdown, container) {
            container.innerHTML = ''; // Clear processing message

            if (!breakdown || breakdown.length === 0) {
                container.innerHTML = '<tr><td colspan="5">No anomalies found that match valuation criteria.</td></tr>';
                return;
            }

            breakdown.forEach(item => {
                const row = container.insertRow();
                const totalValueClass = (item.totalValue > 0) ? 'value-calculated' : 'value-zero';
                
                // Assuming item.siteGroup, item.baseValue, item.totalValue, and item.count are returned by n8n
                row.insertCell().textContent = item.siteType;
                row.insertCell().textContent = item.siteGroup || 'N/A'; // Added Group column
                row.insertCell().textContent = item.count;
                row.insertCell().textContent = formatIsk(item.baseValue);
                
                const totalCell = row.insertCell();
                totalCell.textContent = formatIsk(item.totalValue);
                totalCell.classList.add(totalValueClass); 
            });
        }
    </script>
</body>
</html>




